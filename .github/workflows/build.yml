name: Build and Release with K3s

on:
  workflow_dispatch:
    inputs:
      k3s_version:
        description: 'K3s version (e.g., v1.29.5+k3s1) or "latest" for auto-detection'
        required: false
        default: 'latest'  # ✅ 合理默认值：字符串 "latest" 表示自动获取
      release_tag:
        description: 'Release tag (e.g., v1.0.0) - MUST be a valid tag name'
        required: true
        # ❌ 移除 default: 'latest'（"latest" 不是合法 tag）
  push:
    tags:
      - 'v*'

permissions:
  contents: write

env:
  K3S_GITHUB_REPO: "k3s-io/k3s"
  K3S_API_URL: "https://update.k3s.io/v1-release/channels/stable"

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Determine K3s Version
        id: get_k3s_version
        run: |
          INPUT_VERSION="${{ github.event.inputs.k3s_version }}"
          echo "Input k3s_version: '${INPUT_VERSION}'"
          
          # 判断是否需要自动获取最新版
          if [ -z "$INPUT_VERSION" ] || [ "$INPUT_VERSION" = "latest" ]; then
            echo "Auto-detecting latest stable K3s version..."
            # ✅ 使用官方 API（无需 token，比 gh CLI 更可靠）
            LATEST=$(curl -fsSL "${K3S_API_URL}" | jq -r .latest 2>/dev/null || true)
            
            if [ -z "$LATEST" ] || [ "$LATEST" = "null" ]; then
              echo "❌ Failed to fetch latest K3s version from ${K3S_API_URL}"
              exit 1
            fi
            
            K3S_VERSION="$LATEST"
            echo "Detected latest version: $K3S_VERSION"
          else
            K3S_VERSION="$INPUT_VERSION"
            echo "Using specified version: $K3S_VERSION"
          fi
          
          # 验证版本格式（基本检查）
          if ! echo "$K3S_VERSION" | grep -qE '^v[0-9]+\.[0-9]+\.[0-9]+(\+k3s[0-9]+)?$'; then
            echo "⚠️ Warning: Version '$K3S_VERSION' does not match expected format (e.g., v1.29.5+k3s1)"
            echo "Proceeding anyway..."
          fi
          
          echo "version=$K3S_VERSION" >> $GITHUB_OUTPUT
          echo "K3S_VERSION=$K3S_VERSION" >> $GITHUB_ENV

      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache: true

      - name: Download K3s Assets (AMD64)
        env:
          K3S_VERSION: ${{ steps.get_k3s_version.outputs.version }}
        run: |
          echo "Downloading K3s assets for AMD64: $K3S_VERSION"
          mkdir -p assets-amd64
          
          # ✅ 修复 URL 拼接：移除多余空格
          BASE_URL="https://github.com/${K3S_GITHUB_REPO}/releases/download/${K3S_VERSION}"
          
          # Download k3s binary (amd64)
          curl -fSL "${BASE_URL}/k3s" -o assets-amd64/k3s || { echo "❌ Failed to download k3s binary"; exit 1; }
          chmod +x assets-amd64/k3s
          
          # Download airgap images
          curl -fSL "${BASE_URL}/k3s-airgap-images-amd64.tar.gz" -o assets-amd64/k3s-airgap-images-amd64.tar.gz || { echo "❌ Failed to download airgap images"; exit 1; }
          
          # Download uninstall script (shared across architectures)
          curl -fSL "${BASE_URL}/k3s-uninstall.sh" -o assets-amd64/k3s-uninstall.sh || { echo "❌ Failed to download uninstall script"; exit 1; }
          chmod +x assets-amd64/k3s-uninstall.sh
          
          ls -lh assets-amd64/

      - name: Download K3s Assets (ARM64)
        env:
          K3S_VERSION: ${{ steps.get_k3s_version.outputs.version }}
        run: |
          echo "Downloading K3s assets for ARM64: $K3S_VERSION"
          mkdir -p assets-arm64
          
          BASE_URL="https://github.com/${K3S_GITHUB_REPO}/releases/download/${K3S_VERSION}"
          
          # Download k3s binary (arm64) - note: some versions use 'k3s-arm64', others use 'k3s'
          if curl -fSL "${BASE_URL}/k3s-arm64" -o assets-arm64/k3s 2>/dev/null; then
            echo "Downloaded k3s-arm64 binary"
          elif curl -fSL "${BASE_URL}/k3s" -o assets-arm64/k3s 2>/dev/null; then
            echo "Downloaded generic k3s binary (ARM64 compatible)"
          else
            echo "❌ Failed to download ARM64 k3s binary (tried both 'k3s-arm64' and 'k3s')"
            exit 1
          fi
          chmod +x assets-arm64/k3s
          
          # Download airgap images
          curl -fSL "${BASE_URL}/k3s-airgap-images-arm64.tar.gz" -o assets-arm64/k3s-airgap-images-arm64.tar.gz || { echo "❌ Failed to download ARM64 airgap images"; exit 1; }
          
          # Reuse uninstall script from AMD64 (same file)
          cp assets-amd64/k3s-uninstall.sh assets-arm64/k3s-uninstall.sh
          
          ls -lh assets-arm64/

      - name: Build k3air (linux-amd64)
        env:
          CGO_ENABLED: 0
          GOOS: linux
          GOARCH: amd64
        run: |
          go build -ldflags="-s -w" -o k3air-linux-amd64 .
          ls -lh k3air-linux-amd64

      - name: Build k3air (linux-arm64)
        env:
          CGO_ENABLED: 0
          GOOS: linux
          GOARCH: arm64
        run: |
          go build -ldflags="-s -w" -o k3air-linux-arm64 .
          ls -lh k3air-linux-arm64

      - name: Create Release Directory
        run: mkdir -p release

      - name: Package AMD64 Bundle
        run: |
          tar -czf release/k3air-linux-amd64.tar.gz \
            -C assets-amd64 \
            k3s \
            k3s-airgap-images-amd64.tar.gz \
            k3s-uninstall.sh \
            ../k3air-linux-amd64
          ls -lh release/k3air-linux-amd64.tar.gz

      - name: Package ARM64 Bundle
        run: |
          tar -czf release/k3air-linux-arm64.tar.gz \
            -C assets-arm64 \
            k3s \
            k3s-airgap-images-arm64.tar.gz \
            k3s-uninstall.sh \
            ../k3air-linux-arm64
          ls -lh release/k3air-linux-arm64.tar.gz

      - name: Create Checksums
        working-directory: release
        run: |
          sha256sum *.tar.gz > SHA256SUMS.txt
          cat SHA256SUMS.txt

      - name: Determine Release Tag
        id: get_tag
        run: |
          if [ "${{ github.event_name }}" = "push" ]; then
            # 从 tag 事件获取 (e.g., refs/tags/v1.2.3 → v1.2.3)
            TAG="${GITHUB_REF#refs/tags/}"
          else
            # 从 workflow_dispatch 输入获取
            TAG="${{ github.event.inputs.release_tag }}"
          fi
          
          # 验证 tag 格式
          if ! echo "$TAG" | grep -qE '^v[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?$'; then
            echo "❌ Invalid release tag: '$TAG' (expected format: v1.2.3 or v1.2.3-beta)"
            exit 1
          fi
          
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Release tag: $TAG"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.get_tag.outputs.tag }}
          name: "k3air ${{ steps.get_tag.outputs.tag }} with K3s ${{ steps.get_k3s_version.outputs.version }}"
          body: |
            ## k3air ${{ steps.get_tag.outputs.tag }}

            **K3s version:** ${{ steps.get_k3s_version.outputs.version }}

            ### Downloads

            | File | Architecture | Description |
            |------|--------------|-------------|
            | `k3air-linux-amd64.tar.gz` | AMD64 | Complete bundle (k3air + k3s + airgap images) |
            | `k3air-linux-arm64.tar.gz` | ARM64 | Complete bundle (k3air + k3s + airgap images) |

            ### Verify Checksums

            ```bash
            sha256sum -c SHA256SUMS.txt
            ```
          files: |
            release/k3air-linux-amd64.tar.gz
            release/k3air-linux-arm64.tar.gz
            release/SHA256SUMS.txt
          draft: false
          prerelease: ${{ contains(steps.get_tag.outputs.tag, '-') && !contains(steps.get_tag.outputs.tag, 'rc') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
